!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore"),require("jquery")):"function"==typeof define&&define.amd?define(["exports","underscore","jquery"],e):e(t.Nested={},t._,t.$)}(this,function(s,f,t){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function a(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var u=function(){return(u=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function c(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}function h(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(s=(o<3?i(s):3<o?i(e,n,s):i(e,n))||s);return 3<o&&s&&Object.defineProperty(e,n,s),s}function l(t,e){for(var n in e)e.hasOwnProperty(n)&&!t.hasOwnProperty(n)&&(t[n]=e[n]);if(2<arguments.length)for(var r=2;r<arguments.length;r++){var i=arguments[r];i&&l(t,i)}return t}var p={none:0,error:1,warn:2,info:3,log:4,debug:5},d=function(t,e,n){var r,i,o,s=p[t];if(void 0!==s||n?(r=e,o=t,i=n):(s=4,r=t,i=e,o="log"),s<=d.level){if(s<=d.throw||!d.logger){var a=new Error(r);throw a.props=i,a}d.logger(o,r,i),d.stop}};d.level="undefined"!=typeof process&&process.env&&"production"===process.env.NODE_ENV?1:2,d.throw=0,d.stop=0;var o="undefined"==typeof window?function(t){if(t&&"object"==typeof t){var e=t.__inner_state__||t,n=(Boolean(t.__inner_state__),Array.isArray(e)),r=Object.keys(e).join(", "),i=n?"[ length = "+e.length+" ]":"{ "+r+" }";return t.constructor.name+" "+i}return t}:function(t){return t};function g(t){if(null===t)return!0;switch(typeof t){case"number":case"string":case"boolean":return!0;case"object":var e=Object.getPrototypeOf(t);if(e===Object.prototype||e===Array.prototype)return i(t,g)}return!1}function v(t){return Object.getPrototypeOf(t.prototype).constructor}function e(t){if(t)for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function n(t,e){return Object.getPrototypeOf(t)===w?function(t,e){for(var n,r=0;r<t.length;r++)if(n=e(t[r],r))return n}(t,e):function(t,e){var n;for(var r in t)if(t.hasOwnProperty(r)&&(n=e(t[r],r)))return n}(t,e)}function i(t,e){return!n(t,function(t){return!e(t)})}function y(t){for(var e={},n={},r=1;r<arguments.length;r++)n[arguments[r]]=!0;for(var i in t)!n.hasOwnProperty(i)&&t.hasOwnProperty(i)&&(e[i]=t[i]);return e}function m(t,e,n){for(var r in e)if(e.hasOwnProperty(r)){var i=n(e[r],r);void 0===i||(t[r]=i)}return t}function b(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);if(2<arguments.length)for(var r=2;r<arguments.length;r++){var i=arguments[r];i&&b(t,i)}return t}function _(t){var e,n=!0;return function(){return n&&(n=!1,e=t.apply(this,arguments),t=null),e}}"undefined"!=typeof console&&(d.logger=function(t,e,n){var r=[e];for(var i in n)r.push("\n\t"+i+":",o(n[i]));console[t].apply(console,r)});var w=Array.prototype,O=Date.prototype,E=Object.prototype;function x(t,e){if(t===e)return!1;if(t&&e&&"object"==typeof t&&"object"==typeof e){var n=Object.getPrototypeOf(t);if(n!==Object.getPrototypeOf(e))return!0;switch(n){case O:return+t!=+e;case w:return function(t,e){if(t.length!==e.length)return!0;for(var n=0;n<t.length;n++)if(x(t[n],e[n]))return!0;return!1}(t,e);case E:case null:return function(t,e){var n=Object.keys(t);if(n.length!==Object.keys(e).length)return!0;for(var r=0;r<n.length;r++){var i=n[r];if(!e.hasOwnProperty(i)||x(t[i],e[i]))return!0}return!1}(t,e)}}return!0}var C=Object.create(null);function j(t){var e=Object.create(C);return t?b(e,t):e}C.hasOwnProperty=E.hasOwnProperty;var A=Object.freeze({defaults:l,log:d,isValidJSON:g,getBaseClass:v,assignToClassProto:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];for(var i=0,o=n;i<o.length;i++){var s=o[i],a=e[s];void 0===a||(t.prototype[s]=a)}},isEmpty:e,some:n,every:i,getPropertyDescriptor:function(t,e){for(var n,r=t;!n&&r;r=Object.getPrototypeOf(r))n=Object.getOwnPropertyDescriptor(r,e);return n},omit:y,transform:m,fastAssign:function(t,e){for(var n in e)t[n]=e[n];return t},fastDefaults:function(t,e){for(var n in e)void 0===t[n]&&(t[n]=e[n]);return t},assign:b,keys:function(t){return t?Object.keys(t):[]},once:_,notEqual:x,hashMap:j}),P=function(){function t(){}return t.define=function(t,e){void 0===t&&(t={});var n=v(this);e&&b(this,e);var r=t.mixins,i=c(t,["mixins"]);return r&&this.mixins.merge(r),this.mixins.mergeObject(this.prototype,i,!0),this.mixins.mergeObject(this.prototype,this.mixins.getStaticDefinitions(n),!0),this.onDefine&&this.onDefine(this.mixins.definitions,n),this.mixins.mergeInheritedMembers(n),this},t.extend=function(t,e){var n;return t&&t.hasOwnProperty("constructor")?a(n=t.constructor,this):n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e}(this),S(n),t&&n.define(t,e),n},t}();function S(t){var e=v(t);t.__super__=e.prototype,t.define||R.get(P).populate(t),R.get(t),t.onExtend&&t.onExtend(e)}function N(e){if("function"!=typeof e)return function(t){S(t),t.define(e)};S(e),e.define()}function T(n){return function(t){var e=R.get(t);e.definitionRules=l(j(),n,e.definitionRules)}}function D(n){return function(t,e){(t.hasOwnProperty(n)?t[n]:t[n]=(t[n]||[]).slice()).push(e)}}function k(i,o){return function(t,e){var n,r;R.get(t.constructor).mergeObject(t,((n={})[i]=((r={})[e]=o,r),n))}}var R=function(){function o(t){this.Class=t,this.definitions={};var e=v(t).mixins;this.mergeRules=e&&e.mergeRules||j(),this.definitionRules=e&&e.definitionRules||j(),this.appliedMixins=e&&e.appliedMixins||[]}return o.get=function(t){var e=t.mixins;return e&&t===e.Class?e:t.mixins=new o(t)},o.prototype.getStaticDefinitions=function(n){var t=j(),r=this.Class;return m(t,this.definitionRules,function(t,e){if(n[e]!==r[e])return r[e]})},o.prototype.merge=function(t){for(var e=this.Class.prototype,n=(this.mergeRules,this.appliedMixins=this.appliedMixins.slice()),r=0,i=t;r<i.length;r++){var o=i[r];if(Array.isArray(o))this.merge(o);else if(n.indexOf(o)<0)if(n.push(o),"function"==typeof o){this.mergeObject(this.Class,o);var s=o.mixins;s&&(this.mergeRules=l(j(),this.mergeRules,s.mergeRules),this.definitionRules=l(j(),this.definitionRules,s.definitionRules),this.appliedMixins=this.appliedMixins.concat(s.appliedMixins)),this.mergeObject(e,o.prototype)}else this.mergeObject(e,o)}},o.prototype.populate=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0,r=t;n<r.length;n++){var i=r[n];o.get(i).merge([this.Class])}},o.prototype.mergeObject=function(r,i,o){var s=this;!function(t,e){for(var n=I[typeof t],r=0,i=Object.keys(t);r<i.length;r++){var o=i[r];n[o]||e(o)}}(i,function(t){var e,n=Object.getOwnPropertyDescriptor(i,t);(e=s.definitionRules[t])&&M(s.definitions,t,n,e,o),e&&e!==H.protoValue||M(r,t,n,s.mergeRules[t],o)})},o.prototype.mergeInheritedMembers=function(t){var e=this.mergeRules,n=this.Class;if(e){var r=n.prototype,i=t.prototype;for(var o in e){var s=e[o];r.hasOwnProperty(o)&&o in i&&(r[o]=B(r[o],i[o],s))}}},o}(),I={function:j({length:!0,prototype:!0,caller:!0,arguments:!0,name:!0,__super__:!0}),object:j({constructor:!0})};var U=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return R.get(t).merge(e)}},H=function(n){return function(t){var e=R.get(t);e.mergeRules=l(n,e.mergeRules)}};function M(t,e,n,r,i){if(t.hasOwnProperty(e)){var o=Object.getOwnPropertyDescriptor(t,e);o.configurable&&"value"in o&&(t[e]=i?B(n.value,o.value,r):B(o.value,n.value,r))}else Object.defineProperty(t,e,n)}function B(t,e,n){return void 0===t?e:n&&void 0!==e?n(t,e):t}H.value=function(t,e){return t},H.protoValue=function(t,e){return t},H.merge=function(t,e){return l({},t,e)},H.pipe=function(e,n){return function(t){return e.call(this,n.call(this,t))}},H.defaults=function(t,e){return function(){return l(t.apply(this,arguments),e.apply(this,arguments))}},H.classFirst=function(t,e){return function(){t.apply(this,arguments),e.apply(this,arguments)}},H.classLast=function(t,e){return function(){e.apply(this,arguments),t.apply(this,arguments)}},H.every=function(t,e){return function(){return t.apply(this,arguments)&&e.apply(this,arguments)}},H.some=function(t,e){return function(){return t.apply(this,arguments)||e.apply(this,arguments)}};var J=function(){function e(t){this.handlers=[],t&&(t instanceof e?this.handlers=t.handlers.slice():t&&this.addEventsMap(t))}return e.prototype.merge=function(t){this.handlers=this.handlers.concat(t.handlers)},e.prototype.addEventsMap=function(t){for(var e in t)this.addEvent(e,t[e])},e.prototype.bubbleEvents=function(t){for(var e=0,n=t.split(Q);e<n.length;e++){var r=n[e];this.addEvent(r,z(r))}},e.prototype.addEvent=function(t,e){for(var n=this.handlers,r=0,i=t.split(Q);r<i.length;r++){var o=i[r];n.push(new V(o,e))}},e.prototype.subscribe=function(t,e){for(var n=0,r=this.handlers;n<r.length;n++){var i=r[n];K(e,i.name,i.callback,t)}},e.prototype.unsubscribe=function(t,e){for(var n=0,r=this.handlers;n<r.length;n++){var i=r[n];Z(e,i.name,i.callback,t)}},e}(),V=function(t,e){this.name=t,this.callback=!0===e?z(t):"string"==typeof e?function(){var t=this[e];t&&t.apply(this,arguments)}:e},F={};function z(o){return F[o]||(F[o]=function(t,e,n,r,i){void 0===r&&void 0===i||et(this,o,t,e,n,r,i),void 0!==n?tt(this,o,t,e,n):Y(this,o,t,e)})}var q=function(t,e,n){void 0===n&&(n=null),this.callback=t,this.context=e,this.next=n};function L(t,e,n,r){for(var i,o,s=t[e],a=s;a;a=a.next)n&&n!==a.callback&&n!==a.callback._callback||r&&r!==a.context?(o=a,i||(i=a)):o&&(o.next=a.next);s!==i&&(t[e]=i)}function W(t,e,n,r){for(var i=t;i;i=i.next)i.callback.call(i.context,e,n,r)}function K(t,e,n,r){if(n){var i=t._events||(t._events=Object.create(null));i[e]=new q(n,r,i[e])}}function G(t,e,n,r){if(n){var i=_(function(){Z(t,e,i),n.apply(this,arguments)});i._callback=n,K(t,e,i,r)}}function Z(t,e,n,r){var i=t._events;if(i)if(n||r)if(e)L(i,e,n,r);else for(var o in i)L(i,o,n,r);else e?i[e]=void 0:t._events=void 0}var Q=/\s+/;function X(t,e,n,r,i){if(Q.test(n))for(var o=0,s=n.split(Q);o<s.length;o++){t(e,s[o],r,i)}else t(e,n,r,i)}function Y(t,e,n,r){var i=t._events;if(i){var o=i[e],s=i.all;!function(t,e,n){for(var r=t;r;r=r.next)r.callback.call(r.context,e,n)}(o,n,r),W(s,e,n,r)}}function tt(t,e,n,r,i){var o=t._events;if(o){var s=o[e],a=o.all;W(s,n,r,i),function(t,e,n,r,i){for(var o=t;o;o=o.next)o.callback.call(o.context,e,n,r,i)}(a,e,n,r,i)}}function et(t,e,n,r,i,o,s){var a=t._events;if(a){var u=a[e],c=a.all;!function(t,e,n,r,i,o){for(var s=t;s;s=s.next)s.callback.call(s.context,e,n,r,i,o)}(u,n,r,i,o,s),function(t,e,n,r,i,o,s){for(var a=t;a;a=a.next)a.callback.call(a.context,e,n,r,i,o,s)}(c,e,n,r,i,o,s)}}var nt=Object.freeze({EventMap:J,EventDescriptor:V,EventHandler:q,on:K,once:G,off:Z,strings:X,trigger2:Y,trigger3:tt,trigger5:et}),rt=X,it=K,ot=Z,st=G,at=et,ut=Y,ct=tt,ht=0;function lt(){return"l"+ht++}var pt=function(){function t(){this._events=void 0,this._listeningTo=void 0,this.cid=lt(),this.initialize.apply(this,arguments)}return t.onDefine=function(t,e){var n=t.localEvents,r=t._localEvents,i=t.properties;if(n||r){var o=new J(this.prototype._localEvents);n&&o.addEventsMap(n),r&&o.merge(r),this.prototype._localEvents=o}i&&Object.defineProperties(this.prototype,m({},i,dt))},t.prototype.initialize=function(){},t.prototype.on=function(t,e,n){if("string"==typeof t)rt(it,this,t,e,n);else for(var r in t)rt(it,this,r,t[r],n||e);return this},t.prototype.once=function(t,e,n){if("string"==typeof t)rt(st,this,t,e,n);else for(var r in t)rt(st,this,r,t[r],n||e);return this},t.prototype.off=function(t,e,n){if(t)if("string"==typeof t)rt(ot,this,t,e,n);else for(var r in t)rt(ot,this,r,t[r],n||e);else ot(this,void 0,e,n);return this},t.prototype.trigger=function(t,e,n,r,i,o){return void 0!==i||void 0!==o?at(this,t,e,n,r,i,o):void 0!==r?ct(this,t,e,n,r):ut(this,t,e,n),this},t.prototype.listenTo=function(t,e,n){return t&&(vt(this,t),t.on(e,n||"object"!=typeof e?n:this,this)),this},t.prototype.listenToOnce=function(t,e,n){return t&&(vt(this,t),t.once(e,n||"object"!=typeof e?n:this,this)),this},t.prototype.stopListening=function(t,e,n){var r=this._listeningTo;if(r){var i=!(e||n),o=n||"object"!=typeof e?n:this;if(t){var s=r[t.cid];s&&(i&&delete r[t.cid],s.off(e,o,this))}else if(null==t){for(var a in r)r[a].off(e,o,this);i&&(this._listeningTo=void 0)}}return this},t.prototype.dispose=function(){this._disposed||(this.stopListening(),this.off(),this._disposed=!0)},t=h([N,T({properties:H.merge,localEvents:H.merge})],t)}(),ft=y(pt.prototype,"constructor","initialize");function dt(t){if(t)return"function"==typeof t?{get:t}:t}function vt(t,e){(t._listeningTo||(t._listeningTo=Object.create(null)))[e.cid||(e.cid=lt())]=e}Object.extend=function(t,e){return P.extend(t,e)},Object.assign||(Object.assign=b),Object.log=d;var yt=function(){function i(t){this.length=t._validateNested(this.nested={}),(this.error=t.validate(t))&&this.length++}return i.prototype.each=function(t){var e=this.error,n=this.nested;for(var r in e&&t(e,null),n)t(n[r],r)},i.prototype.eachError=function(n,r){this.each(function(t,e){t instanceof i?t.eachError(n,r.get(e)):n(t,e,r)})},i}(),gt=/\^|(store\.[^.]+)|([^.]+)/g,mt=function(t,e){void 0===e&&(e=!1);var n=t.match(gt).map(function(t){return"^"===t||"owner"===t?"getOwner()":"~"===t[0]?'getStore().get("'+t.substr(1)+'")':0===t.indexOf("store.")?'getStore().get("'+t.substr(6)+'")':t});this.tail=e&&n.pop(),this.local=!n.length,this.resolve=new Function("self","\n            var v = self."+n.shift()+";\n                           \n            "+n.map(function(t){return"\n                v = v && v."+t+";\n            "}).join("")+"\n\n            return v;\n        ")};function bt(t,e,n){for(var r=e.match(gt),i=r.length-1,o=t,s=0;s<i;s++){var a=r[s];switch(a){case"~":o=o.getStore();break;case"^":o=o.getOwner();break;default:o=o.get(a)}if(!o)return}return n(o,r[i])}function _t(t){var e=t.collection;if(e)return _t(e);if(t._owner){var n=t._owner._endpoints;return n&&n[t._ownerKey]}}function wt(n){var r,i,e;function o(t){e=t}var t=new Promise(function(t,e){n(r=t,i=e,o)});return t.abort=function(){e?e(r,i):i(new Error("I/O Aborted"))},t}function Ot(n,t,r,i){return Et(n),r.ioUpdate=!0,n._ioPromise=t.then(function(t){n._ioPromise=null;var e=i?i(t):t;return xt(n,"sync",n,t,r),e}).catch(function(t){throw n._ioPromise=null,console.error(t),xt(n,"error",n,t,r),t}),n._ioPromise.abort=t.abort,n._ioPromise}function Et(t){t._ioPromise&&t._ioPromise.abort&&(t._ioPromise.abort(),t._ioPromise=null)}function xt(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t.trigger.apply(t,e);var r=t.collection;r&&r.trigger.apply(r,e)}var Ct,jt=tt,At=K,Pt=Z;(Ct=s.ItemsBehavior||(s.ItemsBehavior={}))[Ct.share=1]="share",Ct[Ct.listen=2]="listen",Ct[Ct.persistent=4]="persistent";var St=function(){function t(t){this._events=void 0,this._changeToken={},this._transaction=!1,this._isDirty=null,this._owner=void 0,this._ownerKey=void 0,this._validationError=void 0,this.cid=this.cidPrefix+t}var e;return(e=t).onDefine=function(t,e){t.endpoint&&(this.prototype._endpoint=t.endpoint),pt.onDefine.call(this,t,e)},t.onExtend=function(t){t.create===this.create&&(this.create=e.create)},t.create=function(t,e){return new this(t,e)},t.prototype.dispose=function(){this._disposed||(Et(this),this._owner=void 0,this._ownerKey=void 0,this.off(),this.stopListening(),this._disposed=!0)},t.prototype.initialize=function(){},t.prototype.onChanges=function(t,e){At(this,this._changeEventName,t,e)},t.prototype.offChanges=function(t,e){Pt(this,this._changeEventName,t,e)},t.prototype.listenToChanges=function(t,e){this.listenTo(t,t._changeEventName,e)},t.prototype.transaction=function(t,e){void 0===e&&(e={});var n=Nt.begin(this),r=t.call(this,this);r&&this.set(r),n&&Nt.commit(this)},t.prototype.updateEach=function(t,e){var n=Nt.begin(this);this.each(t),n&&Nt.commit(this)},t.prototype.set=function(t,e){if(t){var n=this._createTransaction(t,e);n&&n.commit()}return this},t.prototype.assignFrom=function(e){var n=this;return this.transaction(function(){n.set(e.__inner_state__||e,{merge:!0});var t=e._changeToken;t&&(n._changeToken=t)}),this},t.prototype.parse=function(t,e){return t},t.prototype.deepGet=function(t){return bt(this,t,function(t,e){return t.get?t.get(e):t[e]})},t.prototype.getOwner=function(){return this._owner},t.prototype.getStore=function(){var t=this._owner;return t?t.getStore():this._defaultStore},t.prototype.map=function(n,r){var i=[],o=void 0!==r?function(t,e){return n.call(r,t,e)}:n;return this.each(function(t,e){var n=o(t,e);void 0!==n&&i.push(n)}),i},t.prototype.hasPendingIO=function(){return this._ioPromise},t.prototype.fetch=function(t){throw new Error("Not implemented")},t.prototype.getEndpoint=function(){return function t(e){var n=e.collection;if(n)return t(n);if(e._owner){var r=e._owner._endpoints;return r&&r[e._ownerKey]}}(this)||this._endpoint},t.prototype.mapObject=function(r,t){var i={};return this.each(function(t,e){var n=r(t,e);void 0!==n&&(i[e]=n)}),i},Object.defineProperty(t.prototype,"validationError",{get:function(){var t=this._validationError||(this._validationError=new yt(this));return t.length?t:null},enumerable:!0,configurable:!0}),t.prototype.validate=function(t){},t.prototype.getValidationError=function(t){var e=this.validationError;return(t?e&&e.nested[t]:e)||null},t.prototype.deepValidationError=function(t){return bt(this,t,function(t,e){return t.getValidationError(e)})},t.prototype.eachValidationError=function(t){var e=this.validationError;e&&e.eachError(t,this)},t.prototype.isValid=function(t){return!this.getValidationError(t)},t.prototype.valueOf=function(){return this.cid},t.prototype.toString=function(){return this.cid},t.prototype.getClassName=function(){var t=this.constructor.name;if("Subclass"!==t)return t},t=e=h([N,T({endpoint:H.value}),U(pt)],t)}(),Nt={begin:function(t){return!t._transaction&&(t._transaction=!0)},markAsDirty:function(t,e){var n=!e.silent;return n&&(t._isDirty=e),t._changeToken={},t._validationError=void 0,n},commit:function(t,e){var n=t._isDirty;if(n){for(;t._isDirty;){var r=t._isDirty;t._isDirty=null,jt(t,t._changeEventName,t,r,e)}t._transaction=!1;var i=t._owner;i&&i!==e&&i._onChildrenChange(t,n)}else t._isDirty=null,t._transaction=!1},aquire:function(t,e,n){return e._owner?e._owner===t:(e._owner=t,e._ownerKey=n,!0)},free:function(t,e){t===e._owner&&(e._owner=void 0,e._ownerKey=void 0)}};var Tt=Nt.begin,Dt=Nt.markAsDirty,kt=Nt.commit,Rt=tt;function It(t,e,n){var r=Ut(t),i={};t._attributes[e].doUpdate(n,t,i)&&(Ht(t,i),Rt(t,"change:"+e,t,t.attributes[e],i)),r&&kt(t)}function Ut(t){return!!Tt(t)&&(t._previousAttributes=new t.AttributesCopy(t.attributes),!(t._changedAttributes=null))}function Ht(t,e){return t._changedAttributes&&(t._changedAttributes=null),Dt(t,e)}var Mt={transaction:function(t,e){void 0===e&&(e={});var n=Ut(this);t.call(this,this),n&&kt(this)},_onChildrenChange:function(t,e){var n=t._ownerKey,r=this._attributes[n];r&&!r.propagateChanges||this.forceAttributeChange(n,e)},forceAttributeChange:function(t,e){void 0===e&&(e={});var n=Ut(this);Ht(this,e)&&Rt(this,"change:"+t,this,this.attributes[t],e),n&&kt(this)},_createTransaction:function(t,e){void 0===e&&(e={});var n,r=Ut(this),i=[],o=[],s=this._attributes,a=e.parse?this.parse(t,e):t;if($t(this,a))for(var u in a){var c=s[u];c?c.doUpdate(a[u],this,e,o)&&i.push(u):(n||(n=[]),n.push("'"+u+"'"))}if(i.length&&Ht(this,e))return new Jt(this,r,o,i);for(var h=0,l=o;h<l.length;h++){l[h].commit(this)}r&&kt(this)}};function Bt(t){var e=Object.keys(t),n=new Function("values","\n        "+e.map(function(t){return"\n            this."+t+" = values."+t+";\n        "}).join("")+"\n    ");n.prototype=Object.prototype;var r=new Function("record","values","options","\n        var _attrs = record._attributes;\n\n        "+e.map(function(t){return"\n            this."+t+" = _attrs."+t+".doInit( values."+t+", record, options );\n        "}).join("")+"\n    ");return r.prototype=Object.prototype,{Attributes:r,AttributesCopy:n}}function $t(t,e){return!(!e||e.constructor!==Object)||(t._log("warn","update with non-object is ignored!",{values:e}),!1)}var Jt=function(){function t(t,e,n,r){this.object=t,this.isRoot=e,this.nested=n,this.changes=r}return t.prototype.commit=function(t){for(var e=this.nested,n=this.object,r=this.changes,i=0,o=e;i<o.length;i++){o[i].commit(n)}for(var s=n.attributes,a=n._isDirty,u=0,c=r;u<c.length;u++){var h=c[u];Rt(n,"change:"+h,n,s[h],a)}this.isRoot&&kt(n,t)},t}(),Vt=x,Ft=b,zt={},qt=function(){function r(t,e){this.name=t,this.getHook=null,this.options=e;var n=Ft({getHooks:[],transforms:[],changeHandlers:[]},e);n.getHooks=n.getHooks.slice(),n.transforms=n.transforms.slice(),n.changeHandlers=n.changeHandlers.slice();var r,i=n.value,o=n.type,s=n.parse,a=n.toJSON,u=n.changeEvents,c=n.validate,h=n.getHooks,l=n.transforms,p=n.changeHandlers;if(this.value=i,this.type=o,!n.hasCustomDefault&&o?this.defaultValue=this.create:g(i)?this.defaultValue=new Function("return "+JSON.stringify(i)+";"):this.defaultValue=this.defaultValue,this.propagateChanges=!1!==u,this.toJSON=void 0===a?this.toJSON:a,this.validate=c||this.validate,n.isRequired&&(this.validate=(r=this.validate,function(t,e,n){return e?r.call(this,t,e,n):"Required"})),l.unshift(this.convert),this.get&&h.unshift(this.get),this.initialize.call(this,n),h.length){var f=this.getHook=h.reduce(Lt),d=this.validate;this.validate=function(t,e,n){return d.call(this,t,f.call(t,e,n),n)}}this.transform=l.length?l.reduce(Wt):this.transform,this.handleChange=p.length?p.reduce(Kt):this.handleChange;var v=this.doInit,y=this.doUpdate;this.doInit=s?function(t,e,n){return v.call(this,n.parse&&void 0!==t?s.call(e,t,this.name):t,e,n)}:v,this.doUpdate=s?function(t,e,n,r){return y.call(this,n.parse&&void 0!==t?s.call(e,t,this.name):t,e,n,r)}:y}return r.create=function(t,e){var n=t.type;return new(t._attribute||(n?n._attribute:r))(e,t)},r.prototype.canBeUpdated=function(t,e,n){},r.prototype.transform=function(t,e,n,r){return t},r.prototype.convert=function(t,e,n,r){return t},r.prototype.isChanged=function(t,e){return Vt(t,e)},r.prototype.handleChange=function(t,e,n,r){},r.prototype.create=function(){},r.prototype.clone=function(t,e){return t},r.prototype.dispose=function(t,e){this.handleChange(void 0,e,t,zt)},r.prototype.validate=function(t,e,n){},r.prototype.toJSON=function(t,e,n){return t&&t.toJSON?t.toJSON(n):t},r.prototype.createPropertyDescriptor=function(){var e=this.name,t=this.getHook;if("id"!==e)return{set:function(t){It(this,e,t)},get:t?function(){return t.call(this,this.attributes[e],e)}:function(){return this.attributes[e]}}},r.prototype.initialize=function(t,e){},r.prototype.doInit=function(t,e,n){var r=void 0===t?this.defaultValue():t,i=this.transform(r,void 0,e,n);return this.handleChange(i,void 0,e,n),i},r.prototype.doUpdate=function(t,e,n,r){var i=this.name,o=e.attributes,s=o[i],a=this.transform(t,s,e,n);return o[i]=a,!!this.isChanged(a,s)&&(this.handleChange(a,s,e,n),!0)},r.prototype._log=function(t,e,n,r){d(t,"[Attribute Update Error] "+r.getClassName()+"."+this.name+": "+e,{Record:r,"Attribute definition":this,"Prev. value":r.attributes[this.name],"New value":n})},r.prototype.defaultValue=function(){return this.value},r}();function Lt(n,r){return function(t,e){return r.call(this,n.call(this,t,e),e)}}function Wt(i,o){return function(t,e,n,r){return o.call(this,i.call(this,t,e,n,r),e,n,r)}}function Kt(i,o){return function(t,e,n,r){i.call(this,t,e,n,r),o.call(this,t,e,n,r)}}var Gt=Nt.free,Zt=Nt.aquire,Qt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.clone=function(t){return t?t.clone():t},e.prototype.toJSON=function(t,e,n){return t&&t.toJSON(n)},e.prototype.doInit=function(t,e,n){var r=n.clone?this.clone(t):void 0===t?this.defaultValue():t,i=this.transform(r,void 0,e,n);return this.handleChange(i,void 0,e,n),i},e.prototype.doUpdate=function(t,e,n,r){var i,o=this.name,s=e.attributes,a=s[o];if(i=this.canBeUpdated(a,t,n)){var u=a._createTransaction(i,n);return!(!u||(r?r.push(u):u.commit(e),!this.propagateChanges))}var c=this.transform(t,a,e,n);return s[o]=c,!!this.isChanged(c,a)&&(this.handleChange(c,a,e,n),!0)},e.prototype.canBeUpdated=function(t,e,n){if(t&&null!=e){if(!(e instanceof this.type))return e;if(n.merge)return e.__inner_state__}},e.prototype.convert=function(t,e,n,r){return null==t?t:t instanceof this.type?(!t._shared||t._shared&s.ItemsBehavior.persistent||this._log("error","aggregated collection attribute is assigned with shared collection",t,n),r.merge?t.clone():t):this.type.create(t,r)},e.prototype.dispose=function(t,e){e&&this.handleChange(void 0,e,t,{})},e.prototype.validate=function(t,e){var n=e&&e.validationError;if(n)return n},e.prototype.create=function(){return this.type.create()},e.prototype.initialize=function(t){t.changeHandlers.unshift(this._handleChange)},e.prototype._handleChange=function(t,e,n,r){e&&(Gt(n,e),r.unset||e.dispose()),t&&!Zt(n,t,this.name)&&this._log("error","aggregated attribute assigned with object already having an owner",t,n)},e}(qt),Xt=b,Yt=function(){function r(t){this.options={getHooks:[],transforms:[],changeHandlers:[]},t&&Xt(this.options,t)}return r.prototype.check=function(i,o){function r(t,e,n){if(!i.call(t,e,n)){var r=o||i.error||n+" is not valid";return"function"==typeof r?r.call(t,n):r}}var s=this.options.validate;return this.metadata({validate:s?function(t,e,n){return s(t,e,n)||r(t,e,n)}:r})},Object.defineProperty(r.prototype,"asProp",{get:function(){return k("attributes",this)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"as",{get:function(){return this.asProp},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isRequired",{get:function(){return this.metadata({isRequired:!0})},enumerable:!0,configurable:!0}),r.prototype.endpoint=function(t){return this.metadata({endpoint:t})},r.prototype.watcher=function(t){return this.metadata({_onChange:t})},r.prototype.parse=function(t){return this.metadata({parse:t})},r.prototype.toJSON=function(t){return this.metadata({toJSON:"function"==typeof t?t:t?function(t,e,n){return t&&t.toJSON(n)}:te})},r.prototype.get=function(t){return this.metadata({getHooks:this.options.getHooks.concat(t)})},r.prototype.set=function(o){return this.metadata({transforms:this.options.transforms.concat(function(t,e,n,r){if(this.isChanged(t,e)){var i=o.call(n,t,this.name);return void 0===i?e:this.convert(i,e,n,r)}return e})})},r.prototype.changeEvents=function(t){return this.metadata({changeEvents:t})},r.prototype.events=function(t){var r=new J(t);return this.metadata({changeHandlers:this.options.changeHandlers.concat(function(t,e,n){e&&e.trigger&&r.unsubscribe(n,e),t&&t.trigger&&r.subscribe(n,t)})})},Object.defineProperty(r.prototype,"has",{get:function(){return this},enumerable:!0,configurable:!0}),r.prototype.metadata=function(t){var e=new r(this.options);return Xt(e.options,t),e},r.prototype.value=function(t){return this.metadata({value:t,hasCustomDefault:!0})},r.from=function(t){var e;if("function"==typeof t)e=t.has;else if(t&&t instanceof r)e=t;else{var n=function(t){switch(typeof t){case"number":return Number;case"string":return String;case"boolean":return Boolean;case"undefined":return;case"object":return t?t.constructor:void 0}}(t);e=n&&n.prototype instanceof St?n.shared.value(t):new r({type:n,value:t,hasCustomDefault:!0})}return e},r}();function te(){}function ee(t){return t instanceof Yt?t:new Yt({type:t,value:t._attribute.defaultValue,hasCustomDefault:void 0!==t._attribute.defaultValue})}Function.prototype.value=function(t){return new Yt({type:this,value:t,hasCustomDefault:!0})},Object.defineProperty(Function.prototype,"isRequired",{get:function(){return this._isRequired||this.has.isRequired},set:function(t){this._isRequired=t}}),Object.defineProperty(Function.prototype,"asProp",{get:function(){return this.has.asProp}}),Object.defineProperty(Function.prototype,"has",{get:function(){return this._has||ee(this)},set:function(t){this._has=t}});var ne=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.create=function(){return new Date},e.prototype.convert=function(t,e,n){if(null==t||t instanceof Date)return t;var r=new Date(t),i=r.getTime();return i!=i&&this._log("warn","assigned with Invalid Date",t,n),r},e.prototype.validate=function(t,e,n){if(null!=e){var r=e.getTime();if(r!=r)return n+" is Invalid Date"}},e.prototype.toJSON=function(t){return t&&t.toISOString()},e.prototype.isChanged=function(t,e){return(t&&t.getTime())!==(e&&e.getTime())},e.prototype.doInit=function(t,e,n){return this.transform(void 0===t?this.defaultValue():t,void 0,e,n)},e.prototype.doUpdate=function(t,e,n,r){var i=this.name,o=e.attributes,s=o[i];return this.isChanged(s,o[i]=this.transform(t,s,e,n))},e.prototype.clone=function(t){return t&&new Date(t.getTime())},e.prototype.dispose=function(){},e}(qt);Date._attribute=ne;var re=/\/Date\(([0-9]+)\)\//,ie=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.convert=function(t){if("string"==typeof t){var e=re.exec(t);if(e)return new Date(Number(e[1]))}return ne.prototype.convert.apply(this,arguments)},e.prototype.toJSON=function(t){return t&&"/Date("+t.getTime()+")/"},e}(ne),oe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.toJSON=function(t){return t&&t.getTime()},e}(ne);function se(t){return!isNaN(new Date(t).getTime())}Object.defineProperties(Date,{microsoft:{get:function(){return new Yt({type:Date,_attribute:ie})}},timestamp:{get:function(){return new Yt({type:Date,_attribute:oe})}}}),se("2011-11-29T15:52:30.5")&&se("2011-11-29T15:52:30.52")&&se("2011-11-29T15:52:18.867")&&se("2011-11-29T15:52:18.867Z")&&se("2011-11-29T15:52:18.867-03:30")||(ne.prototype.convert=function(t){return null==t||t instanceof Date?t:new Date(function(t){var e,n,r=0;if(n=ue.exec(t)){for(var i,o=0;i=ae[o];++o)n[i]=+n[i]||0;n[2]=(+n[2]||1)-1,n[3]=+n[3]||1,"Z"!==n[8]&&void 0!==n[9]&&(r=60*n[10]+n[11],"+"===n[9]&&(r=0-r)),e=Date.UTC(n[1],n[2],n[3],n[4],n[5]+r,n[6],n[7])}else e=Date.parse(t);return e}(t))});var ae=[1,4,5,6,7,10,11],ue=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/;var ce=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.create=function(){return new this.type},e.prototype.convert=function(t){return null==t||t instanceof this.type?t:new this.type(t)},e.prototype.toJSON=function(t,e,n){return t&&t.toJSON?t.toJSON(n):t},e.prototype.clone=function(t){return new this.type(this.toJSON(t))},e.prototype.isChanged=function(t,e){return t!==e},e}(qt);Function.prototype._attribute=ce;var he=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.dispose=function(){},e.prototype.create=function(){return this.type()},e.prototype.toJSON=function(t){return t},e.prototype.convert=function(t){return null==t?t:this.type(t)},e.prototype.isChanged=function(t,e){return t!==e},e.prototype.clone=function(t){return t},e.prototype.doInit=function(t,e,n){return this.transform(void 0===t?this.value:t,void 0,e,n)},e.prototype.doUpdate=function(t,e,n,r){var i=this.name,o=e.attributes,s=o[i];return s!==(o[i]=this.transform(t,s,e,n))},e.prototype.initialize=function(){this.options.hasCustomDefault||(this.value=this.type())},e}(qt);Boolean._attribute=String._attribute=he;var le=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.create=function(){return 0},e.prototype.convert=function(t,e,n){var r=null==t?t:this.type(t);return r!=r&&this._log("warn","assigned with Invalid Number",t,n),r},e.prototype.validate=function(t,e,n){if(null!=e&&!isFinite(e))return n+" is not valid number"},e}(he);function pe(t){return t?Math.round(t):0}Number._attribute=le,pe._attribute=le,Number.integer=pe,"undefined"!=typeof window&&(window.Integer=Number.integer);var fe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.toJSON=function(t){return t},e.prototype.dispose=function(){},e.prototype.create=function(){return[]},e.prototype.convert=function(t,e,n){return null==t||Array.isArray(t)?t:(this._log("warn","assignment of non-array to Array attribute is ignored",t,n),[])},e.prototype.clone=function(t){return t&&t.slice()},e}(qt);Array._attribute=fe;var de=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.create=function(){return{}},e.prototype.convert=function(t,e,n){return null==t||"object"==typeof t?t:(this._log("warn","assignment of non-object to Object attribute is ignored",t,n),{})},e}(qt);function ve(){}Object._attribute=de;var ye=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.toJSON=function(t){},e.prototype.create=function(){return ve},e.prototype.dispose=function(){},e.prototype.convert=function(t,e,n){return null==t||"function"==typeof t?t:(this._log("warn","assigned with non-function",t,n),ve)},e.prototype.clone=function(t){return t},e}(qt);Function._attribute=ye;var ge=K,me=Z,be=Nt.free,_e=Nt.aquire,we=s.ItemsBehavior.listen|s.ItemsBehavior.share,Oe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.doInit=function(t,e,n){var r=n.clone?this.clone(t,e):void 0===t?this.defaultValue():t,i=this.transform(r,void 0,e,n);return this.handleChange(i,void 0,e,n),i},e.prototype.doUpdate=function(t,e,n,r){var i,o=this.name,s=e.attributes,a=s[o];if(i=this.canBeUpdated(a,t,n)){var u=a._createTransaction(i,n);return!(!u||(r?r.push(u):u.commit(e),!this.propagateChanges))}var c=this.transform(t,a,e,n);return s[o]=c,!!this.isChanged(c,a)&&(this.handleChange(c,a,e,n),!0)},e.prototype.clone=function(t,e){if(!t||t._owner!==e)return t;var n=t.clone();return _e(e,n,this.name),n},e.prototype.toJSON=function(){},e.prototype.canBeUpdated=function(t,e,n){if(t&&null!=e&&!(e instanceof this.type))return e},e.prototype.convert=function(t,e,n,r){if(null==t||t instanceof this.type)return t;var i=new this.type(t,r,we);return _e(n,i,this.name),i},e.prototype.validate=function(t,e,n){},e.prototype.create=function(){return null},e.prototype._handleChange=function(t,e,n,r){e&&(e._owner===n?(be(n,e),r.unset||e.dispose()):me(e,e._changeEventName,this._onChange,n)),t&&t._owner!==n&&ge(t,t._changeEventName,this._onChange,n)},e.prototype.dispose=function(t,e){e&&this.handleChange(void 0,e,t,{})},e.prototype.initialize=function(t){var r=this;this._onChange=this.propagateChanges?function(t,e,n){this===n||this.forceAttributeChange(r.name,e)}:Ee,t.changeHandlers.unshift(this._handleChange)},e}(qt);function Ee(){}function xe(t,e){var n=m({},t,Ce),r=l({},n,e),i=Bt(r);return u({},i,{_attributes:new i.AttributesCopy(r),_attributesArray:Object.keys(r).map(function(t){return r[t]}),properties:m({},n,function(t){return t.createPropertyDescriptor()})},function(t){var e;for(var n in t){var r=t[n],i=r.options._onChange;i&&(e||(e=new J),e.addEvent("change:"+n,"string"==typeof i?Pe(i,n):Ae(i,n)))}return e?{_localEvents:e}:{}}(n),{_endpoints:m({},r,function(t){return t.options.endpoint})})}function Ce(t,e){return qt.create(Yt.from(t).options,e)}function je(t,e){t.hasOwnProperty("shared")||Object.defineProperty(t,"shared",{get:function(){return new Yt({value:null,type:t,_attribute:e})}})}function Ae(n,r){return function(t,e){n.call(t,e,r)}}function Pe(t,n){var e=new mt(t,!0),r=e.local,i=e.resolve,o=e.tail;return r?function(t,e){t[o](e,n)}:function(t,e){i(t)[o](e,n)}}var Se={save:function(e){var n=this;void 0===e&&(e={});var t=this.getEndpoint(),r=this.toJSON(e);return Ot(this,this.isNew()?t.create(r,e,this):t.update(this.id,r,e,this),e,function(t){n.set(t,u({parse:!0},e))})},fetch:function(e){var n=this;return void 0===e&&(e={}),Ot(this,this.getEndpoint().read(this.id,e,this),e,function(t){return n.set(t,u({parse:!0},e))})},destroy:function(e){var n=this;return void 0===e&&(e={}),Ot(this,this.getEndpoint().destroy(this.id,e,this),e,function(){var t=n.collection;return t?t.remove(n,e):n.dispose(),n})}},Ne=b,Te=e,De=d,ke=0,Re=function(o){function t(t,e){var n=o.call(this,ke++)||this;n.attributes={};var r=e||{},i=(r.parse?n.parse(t,r):t)||{};return 1<De.level&&function(t,e){if($t(t,e)){var n=t._attributes,r=void 0;for(var i in e)n[i]||(r||(r=[]),r.push("'"+i+"'"));r&&t._log("warn","undefined attributes "+r.join(", ")+" are ignored.",{values:e})}}(n,i),n._previousAttributes=n.attributes=new n.Attributes(n,i,r),n.initialize(t,e),n._localEvents&&n._localEvents.subscribe(n,n),n}return a(t,o),t.onDefine=function(t,e){},t.defaults=function(t){return this.extend({attributes:t})},t.prototype.save=function(t){throw new Error("Implemented by mixin")},t.prototype.destroy=function(t){throw new Error("Implemented by mixin")},t.prototype.previousAttributes=function(){return new this.AttributesCopy(this._previousAttributes)},Object.defineProperty(t.prototype,"__inner_state__",{get:function(){return this.attributes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"changed",{get:function(){var t=this._changedAttributes;if(!t){var e=this._previousAttributes;t={};this._attributes;for(var n=this.attributes,r=0,i=this._attributesArray;r<i.length;r++){var o=i[r],s=o.name,a=n[s];o.isChanged(a,e[s])&&(t[s]=a)}this._changedAttributes=t}return t},enumerable:!0,configurable:!0}),t.prototype.changedAttributes=function(t){if(!t)return!!this.hasChanged()&&Ne({},this.changed);var e,n=!1,r=this._transaction?this._previousAttributes:this.attributes,i=this._attributes;for(var o in t)i[o].isChanged(r[o],e=t[o])&&((n||(n={}))[o]=e);return n},t.prototype.hasChanged=function(t){var e=this._previousAttributes;return!!e&&(t?this._attributes[t].isChanged(this.attributes[t],e[t]):!Te(this.changed))},t.prototype.previous=function(t){if(t){var e=this._previousAttributes;if(e)return e[t]}return null},t.prototype.isNew=function(){return null==this.id},t.prototype.has=function(t){return null!=this[t]},t.prototype.unset=function(t,e){var n,r=this[t];return this.set(((n={})[t]=void 0,n),u({unset:!0},e)),r},t.prototype.clear=function(t){var n=this,r=t&&t.nullify;return this.transaction(function(){n.forEachAttr(n.attributes,function(t,e){return n[e]=r?null:void 0})},t),this},t.prototype.getOwner=function(){var t=this._owner;return this._ownerKey?t:t&&t._owner},Object.defineProperty(t.prototype,"id",{get:function(){return this.attributes[this.idAttribute]},set:function(t){It(this,this.idAttribute,t)},enumerable:!0,configurable:!0}),t.prototype.forEachAttr=function(t,e){var n,r=this._attributes;for(var i in t){var o=r[i];o?e(t[i],i,o):(n||(n=[]),n.push("'"+i+"'"))}n&&this._log("warn","attributes "+n.join(", ")+" are not defined",{attributes:t})},t.prototype.each=function(n,r){var t=void 0!==r?function(t,e){return n.call(r,t,e)}:n,e=this.attributes;for(var i in this.attributes){var o=e[i];void 0!==o&&t(o,i)}},t.prototype.keys=function(){var n=[];return this.each(function(t,e){return void 0===t||n.push(e)}),n},t.prototype.values=function(){return this.map(function(t){return t})},t.prototype.defaults=function(t){void 0===t&&(t={});for(var e={},n=0,r=this._attributesArray;n<r.length;n++){var i=r[n],o=i.name,s=t[o];e[o]=void 0===s?i.defaultValue():s}return e},t.prototype.initialize=function(t,e){},t.prototype.clone=function(t){void 0===t&&(t={});var e=new this.constructor(this.attributes,{clone:!0});return t.pinStore&&(e._defaultStore=this.getStore()),e},t.prototype.deepClone=function(){return this.clone()},t.prototype._validateNested=function(i){var o=this,s=0;return this.forEachAttr(this.attributes,function(t,e,n){var r=n.validate(o,t,e);r&&(i[e]=r,s++)}),s},t.prototype.get=function(t){return this[t]},t.prototype.toJSON=function(o){var s=this,a={};return this.forEachAttr(this.attributes,function(t,e,n){var r=n.toJSON;if(void 0!==t){var i=r.call(s,t,e,o);void 0!==i&&(a[e]=i)}}),a},t.prototype.parse=function(t,e){return t},t.prototype._parse=function(t){return t},t.prototype.deepSet=function(h,l,p){var f=this;return this.transaction(function(){for(var t,e=h.split("."),n=e.length-1,r=e[n],i=f,o=0;o<n;o++){var s=e[o],a=i.get?i.get(s):i[s];if(!a){var u=i._attributes;if(!u)return;var c=u[s].create();p&&p.nullify&&c._attributes&&c.clear(p),i[s]=a=c}i=a}i.set?i.set(((t={})[r]=l,t),p):i[r]=l}),this},Object.defineProperty(t.prototype,"collection",{get:function(){return this._ownerKey?null:this._owner},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){var r=this;this._disposed||(this.forEachAttr(this.attributes,function(t,e,n){n.dispose(r,t)}),o.prototype.dispose.call(this))},t.prototype._log=function(t,e,n){d(t,"[Record] "+e,u({Record:this,"Attributes definition:":this._attributes},n))},t.prototype.getClassName=function(){return o.prototype.getClassName.call(this)||"Record"},t.prototype._createTransaction=function(t,e){},t=h([N({cidPrefix:"m",_changeEventName:"change",idAttribute:"id"}),T({defaults:H.merge,attributes:H.merge,collection:H.merge,Collection:H.value,idAttribute:H.protoValue})],t)}(St);Ne(Re.prototype,Mt,Se);var Ie=function(t,e,n){this.id=e.id};Re.prototype.Attributes=Ie;var Ue=function(t){this.id=t.id};Re.prototype.AttributesCopy=Ue;var He=qt.create({value:void 0},"id");Re.prototype._attributes={id:He},Re.prototype._attributesArray=[He],Re._attribute=Qt;var Me=b,Be=l;function $e(t,e){if(!e)return Yt.from(t).asProp;"undefined"!=typeof Reflect&&Reflect.getMetadata?Reflect.getMetadata("design:type",t,e).asProp(t,e):t._log("error",'Add import "reflect-metadata"; as the first line of your app.')}function Je(t){return t.asProp}Re.onExtend=function(t){St.onExtend.call(this,t);var n=this,e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.model=n,e=h([S],e)}(t.Collection);this.DefaultCollection=e,n.Collection===t.Collection&&(this.Collection=e),je(this,Oe)},Re.onDefine=function(t,e){var n=e.prototype,r=xe(this.attributes=function(t){var e=t.defaults,n=t.attributes,r=t.idAttribute,i=n||e||{};!r||r in i||(i[r]=void 0);return i}(t),n._attributes),i=r.properties,o=r._localEvents,s=c(r,["properties","_localEvents"]);Me(this.prototype,s),t.properties=Be(t.properties||{},i),t._localEvents=o,St.onDefine.call(this,t,e),this.DefaultCollection.define(t.collection||{}),this.Collection=t.Collection,this.Collection.prototype.model=this,t.endpoint&&(this.Collection.prototype._endpoint=t.endpoint)},Re._attribute=Qt,je(Re,Oe);var Ve=Y,Fe=tt,ze=K,qe=Z,Le=Nt.commit,We=Nt.aquire,Ke=Nt.free;function Ge(t,e,n){var r,i=t.model;t._shared?(r=e instanceof i?e:i.create(e,n),t._shared&s.ItemsBehavior.listen&&ze(r,r._changeEventName,t._onChildrenChange,t)):(r=e instanceof i?n.merge?e.clone():e:i.create(e,n),We(t,r)||(t._aggregationError||(t._aggregationError=[])).push(r));var o=t._itemEvents;return o&&o.subscribe(t,r),r}function Ze(t,e,n){t._shared?t._shared&s.ItemsBehavior.listen&&qe(e,e._changeEventName,t._onChildrenChange,t):(Ke(t,e),n||e.dispose());var r=t._itemEvents;r&&r.unsubscribe(t,e)}function Qe(t,e){var n=t._comparator;return!(!n||!1===e.sort)&&(t.models.sort(n),!0)}function Xe(t,e){var n=(t[e.cid]=e).id;(n||0===n)&&(t[n]=e)}function Ye(t,e){delete t[e.cid];var n=e.id;(n||0===n)&&delete t[n]}function tn(t,e){delete t[e.previous(e.idAttribute)];var n=e.id;null==n||(t[n]=e)}var en=function(){function t(t,e,n,r,i,o){this.object=t,this.isRoot=e,this.added=n,this.removed=r,this.nested=i,this.sorted=o}return t.prototype.commit=function(t){for(var e=this.nested,n=this.object,r=n._isDirty,i=0,o=e;i<o.length;i++){(u=o[i]).commit(n)}n._aggregationError&&nn(n);for(var s=0,a=e;s<a.length;s++){var u=a[s];Ve(n,"change",u.object,r)}for(var c=this.added,h=this.removed,l=0,p=c;l<p.length;l++){var f=p[l];Fe(f,"add",f,n,r),Fe(n,"add",f,n,r)}for(var d=0,v=h;d<v.length;d++){f=v[d];Fe(f,"remove",f,n,r),Fe(n,"remove",f,n,r)}this.sorted&&Ve(n,"sort",n,r),(c.length||h.length)&&Ve(n,"update",n,r),this.isRoot&&Le(n,t)},t}();function nn(t){t._log("error","added records already have an owner",t._aggregationError),t._aggregationError=void 0}var rn=Nt.begin,on=Nt.commit,sn=Nt.markAsDirty;function an(t,e,n,r){var i=rn(t),o=[],s=function(t,e,n,r,i){for(var o=t._byId,s=t.models,a=(i||r.merge)&&!t._shared,u=(r.parse,t.model.prototype.idAttribute),c=s.length,h=0,l=e;h<l.length;h++){var p=l[h],f=p?o[p[u]]||o[p.cid]:null;if(f){if(a&&p!==f){var d=p.attributes||p,v=f._createTransaction(d,r);v&&n.push(v),f.hasChanged(u)&&tn(o,f)}}else f=Ge(t,p,r),s.push(f),Xe(o,f)}return s.slice(c)}(t,e,o,n,r);if(s.length||o.length){var a=function(t,e,n){var r=n.at;if(null!=r){var i=t.models.length-e.length;return(r=Number(r))<0&&(r+=i+1),r<0&&(r=0),i<r&&(r=i),function(t,e,n){for(var r=t.length-1,i=r-n.length;e<=i;i--,r--)t[r]=t[i];for(i=0,r=e;i<n.length;i++,r++)t[r]=n[i]}(t.models,r,e),!1}return Qe(t,n)}(t,s,n);if(sn(t,n))return new en(t,i,s,[],o,a);t._aggregationError&&nn(t)}i&&on(t)}var un=Nt.begin,cn=Nt.commit,hn=Nt.markAsDirty,ln={silent:!0};function pn(t,e,n,r){var i=un(t),o=function(t,e,n){for(var r=e?e.length:0,i=Array(r),o={},s=t.model.prototype.idAttribute,a=0,u=0;a<r;a++){var c=e[a];if(!c||!o[c[s]]&&!o[c.cid]){var h=Ge(t,c,n);i[u++]=h,Xe(o,h)}}return i.length=u,t._byId=o,t.models=i}(t,e,n);if(o.length){var s=Qe(t,n);if(hn(t,r?ln:n))return new en(t,i,o.slice(),[],[],s);t._aggregationError&&nn(t)}i&&cn(t)}function fn(t,e,n){var r=un(t),i=[],o=t.models,s=function(t,e,n,r){for(var i=Array(e.length),o={},s=(null==r.merge||r.merge)&&!t._shared,a=t._byId,u=t.models,c=t.model.prototype.idAttribute,h=[],l=!0,p=0,f=0;p<e.length;p++){var d=e[p],v=null;if(d){var y=d[c],g=d.cid;if(o[y]||o[g])continue;v=a[y]||a[g]}if(v){if(s&&d!==v){l&&u[f]!==v&&(l=!1);var m=d.attributes||d,b=v._createTransaction(m,r);b&&n.push(b)}}else v=Ge(t,d,r),h.push(v);i[f++]=v,Xe(o,v)}i.length=f,t.models=i,t._byId=o,l||(r.sorted=!0);return h}(t,e,i,n),a=t.models.length-s.length,u=a<o.length?a?function(t,e){for(var n=t._byId,r=[],i=0,o=e;i<o.length;i++){var s=o[i];n[s.cid]||(r.push(s),Ze(t,s))}return r}(t,o):function(t,e){for(var n=0,r=e;n<r.length;n++)Ze(t,r[n]);return e}(t,o):[],c=i.length||s.length,h=Qe(t,n)&&c||s.length||n.sorted;if(c||u.length||h){if(hn(t,n))return new en(t,r,s,u,i,h);t._aggregationError&&nn(t)}r&&cn(t)}var dn=Y,vn=tt,yn=Nt.markAsDirty,gn=Nt.begin,mn=Nt.commit;function bn(t,e,n){var r=function(t,e,n){for(var r=Array(e.length),i=t._byId,o=0,s=0;o<e.length;o++){var a=t.get(e[o]);a&&(r[s++]=a,Ye(i,a),Ze(t,a,n))}return r.length=s,r}(t,e,n.unset);if(r.length){var i=gn(t);if(function(t,e){for(var n=t.models,r=t.models=Array(n.length-e),i=t._byId,o=0,s=0;o<n.length;o++){var a=n[o];i[a.cid]&&(r[s++]=a)}r.length=s}(t,r.length),yn(t,n))new en(t,i,[],r,[],!1).commit();else i&&mn(t)}return r}var _n=Y,wn=Nt.begin,On=Nt.commit,En=Nt.markAsDirty,xn=b,Cn=l,jn=0,An=Array.prototype.slice,Pn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.defaultValue=[],e}(Oe),Sn=function(i){function t(t,e,n){void 0===e&&(e={});var r=i.call(this,jn++)||this;(r.models=[],r._byId={},r.comparator=r.comparator,void 0!==e.comparator&&(r.comparator=e.comparator,e.comparator=void 0),r.model=r.model,e.model&&(r.model=e.model,e.model=void 0),r.idAttribute=r.model.prototype.idAttribute,r._shared=n||0,t)&&pn(r,Nn(r,t,e),e,!0);return r.initialize.apply(r,arguments),r._localEvents&&r._localEvents.subscribe(r,r),r}return a(t,i),t.prototype.createSubset=function(t,e){var n=new(this.constructor.subsetOf(this).options.type)(t,e);return n.resolve(this),n},t.onExtend=function(t){var r=this;function e(t,e,n){r.call(this,t,e,s.ItemsBehavior.share|(n?s.ItemsBehavior.listen:0))}this._SubsetOf=null,P.mixins.populate(e),e.prototype=this.prototype,e._attribute=Pn,this.Refs=this.Subset=e,St.onExtend.call(this,t),je(this,Oe)},t.onDefine=function(t,e){if(t.itemEvents){var n=new J(e.prototype._itemEvents);n.addEventsMap(t.itemEvents),this.prototype._itemEvents=n}void 0!==t.comparator&&(this.prototype.comparator=t.comparator),St.onDefine.call(this,t)},Object.defineProperty(t.prototype,"__inner_state__",{get:function(){return this.models},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"comparator",{get:function(){return this._comparator},set:function(i){var o=this;switch(typeof i){case"string":this._comparator=function(t,e){var n=t[i],r=e[i];return n===r?0:n<r?-1:1};break;case"function":1===i.length?this._comparator=function(t,e){var n=i.call(o,t),r=i.call(o,e);return n===r?0:n<r?-1:1}:this._comparator=function(t,e){return i.call(o,t,e)};break;default:this._comparator=null}},enumerable:!0,configurable:!0}),t.prototype.getStore=function(){return this._store||(this._store=this._owner?this._owner.getStore():this._defaultStore)},t.prototype._onChildrenChange=function(t,e,n){if(void 0===e&&(e={}),n!==this){var r=this.idAttribute;t.hasChanged(r)&&tn(this._byId,t);var i=wn(this);En(this,e)&&_n(this,"change",t,e),i&&On(this)}},t.prototype.get=function(t){if(null!=t){if("object"==typeof t){var e=t[this.idAttribute];return void 0!==e&&this._byId[e]||this._byId[t.cid]}return this._byId[t]}},t.prototype.each=function(t,e){for(var n=Tn(t,e),r=this.models,i=0;i<r.length;i++)n(r[i],i)},t.prototype.forEach=function(t,e){return this.each(t,e)},t.prototype.every=function(t,e){for(var n=Dn(t,e),r=this.models,i=0;i<r.length;i++)if(!n(r[i],i))return!1;return!0},t.prototype.filter=function(t,e){var n=Dn(t,e);this.models;return this.map(function(t,e){return n(t,e)?t:void 0})},t.prototype.find=function(t,e){for(var n=Dn(t,e),r=this.models,i=0;i<r.length;i++)if(n(r[i],i))return r[i];return null},t.prototype.some=function(t,e){return Boolean(this.find(t,e))},t.prototype.map=function(t,e){for(var n=Tn(t,e),r=this.models,i=Array(r.length),o=0,s=0;s<r.length;s++){var a=n(r[s],s);void 0===a||(i[o++]=a)}return i.length=o,i},t.prototype._validateNested=function(n){if(this._shared)return 0;var r=0;return this.each(function(t){var e=t.validationError;e&&(n[t.cid]=e,r++)}),r},t.prototype.initialize=function(){},Object.defineProperty(t.prototype,"length",{get:function(){return this.models.length},enumerable:!0,configurable:!0}),t.prototype.first=function(){return this.models[0]},t.prototype.last=function(){return this.models[this.models.length-1]},t.prototype.at=function(t){var e=t<0?t+this.models.length:t;return this.models[e]},t.prototype.clone=function(t){void 0===t&&(t={});var e=this._shared&s.ItemsBehavior.share?this.models:this.map(function(t){return t.clone()}),n=new this.constructor(e,{model:this.model,comparator:this.comparator},this._shared);return t.pinStore&&(n._defaultStore=this.getStore()),n},t.prototype.toJSON=function(e){return this.models.map(function(t){return t.toJSON(e)})},t.prototype.set=function(t,e){if(void 0===t&&(t=[]),void 0===e&&(e={}),void 0!==e.add&&this._log("warn","Collection.set doesn't support 'add' option, behaving as if options.add === true.",e),e.reset)this.reset(t,e);else{var n=this._createTransaction(t,e);n&&n.commit()}return this},t.prototype.liveUpdates=function(t){var e=this;if(t){this.liveUpdates(!1);var n="function"==typeof t?t:function(){return!0};return this._liveUpdates={updated:function(t){n(t)&&e.add(t,{parse:!0,merge:!0})},removed:function(t){return e.remove(t)}},this.getEndpoint().subscribe(this._liveUpdates,this).then(function(){return e})}this._liveUpdates&&(this.getEndpoint().unsubscribe(this._liveUpdates,this),this._liveUpdates=null)},t.prototype.fetch=function(t){var n=this;void 0===t&&(t={});var r=u({parse:!0},t);return Ot(this,this.getEndpoint().list(r,this),r,function(t){var e=n.set(t,u({parse:!0},r));return r.liveUpdates&&(e=n.liveUpdates(r.liveUpdates)),e})},t.prototype.dispose=function(){if(!this._disposed){for(var t=!this._shared,e=0,n=this.models;e<n.length;e++){var r=n[e];Ze(this,r),t&&r.dispose()}this.liveUpdates(!1),i.prototype.dispose.call(this)}},t.prototype.reset=function(t,e){void 0===e&&(e={});var n=wn(this),r=this.models;t?pn(this,Nn(this,t,e),e,!0):(this._byId={},this.models=[]),En(this,e),e.silent||_n(this,"reset",this,Cn({previousModels:r},e));for(var i=this._byId,o=0,s=r;o<s.length;o++){var a=s[o];i[a.cid]||Ze(this,a)}return n&&On(this),this.models},t.prototype.add=function(t,e){void 0===e&&(e={});var n=Nn(this,t,e),r=this.models.length?an(this,n,e):pn(this,n,e);if(r)return r.commit(),r.added},t.prototype.remove=function(t,e){return void 0===e&&(e={}),t?Array.isArray(t)?bn(this,t,e):function(t,e,n){var r=t.get(e);if(r){var i=gn(t),o=t.models;o.splice(o.indexOf(r),1),Ye(t._byId,r);var s=yn(t,n);return s&&(vn(r,"remove",r,t,n),vn(t,"remove",r,t,n)),Ze(t,r,n.unset),s&&dn(t,"update",t,n),i&&mn(t),r}}(this,t,e):[]},t.prototype._createTransaction=function(t,e){void 0===e&&(e={});var n=Nn(this,t,e);return this.models.length?!1===e.remove?an(this,n,e,!0):fn(this,n,e):pn(this,n,e)},t.prototype.pluck=function(e){return this.models.map(function(t){return t[e]})},t.prototype.sort=function(t){if(void 0===t&&(t={}),Qe(this,t)){var e=wn(this);En(this,t)&&_n(this,"sort",this,t),e&&On(this)}return this},t.prototype.push=function(t,e){return this.add(t,xn({at:this.length},e))},t.prototype.pop=function(t){var e=this.at(this.length-1);return this.remove(e,u({unset:!0},t)),e},t.prototype.unset=function(t,e){var n=this.get(t);return this.remove(t,u({unset:!0},e)),n},t.prototype.unshift=function(t,e){return this.add(t,xn({at:0},e))},t.prototype.shift=function(t){var e=this.at(0);return this.remove(e,u({unset:!0},t)),e},t.prototype.slice=function(){return An.apply(this.models,arguments)},t.prototype.indexOf=function(t){var e=this.get(t);return this.models.indexOf(e)},t.prototype.modelId=function(t){return t[this.model.prototype.idAttribute]},t.prototype.toggle=function(t,e){var n=Boolean(this.get(t)),r=void 0===e?!n:Boolean(e);return n!==r&&(n?this.remove(t):this.add(t)),r},t.prototype._log=function(t,e,n){d(t,"[Collection Update] "+this.model.prototype.getClassName()+"."+this.getClassName()+": "+e,{Argument:n,"Attributes spec":this.model.prototype._attributes})},t.prototype.getClassName=function(){return i.prototype.getClassName.call(this)||"Collection"},t._attribute=Qt,t=h([N({cidPrefix:"c",model:Re,_changeEventName:"changes",_aggregationError:null}),T({comparator:H.value,model:H.protoValue,itemEvents:H.merge})],t)}(St);function Nn(t,e,n){var r=n.parse?t.parse(e,n):e;return Array.isArray(r)?r:[r]}function Tn(n,r){return void 0!==r?function(t,e){return n.call(r,t,e)}:n}function Dn(n,t){return"object"==typeof n?function(t){for(var e in n)if(n[e]!==t[e])return!1;return!0}:Tn(n,t)}function kn(e){switch(typeof e){case"function":return function(t){return e.call(t)};case"object":return function(){return e};case"string":return new mt(e).resolve}}je(Sn,Oe),Re.Collection=Sn;var Rn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.toJSON=function(t){return t&&"object"==typeof t?t.id:t},e.prototype.clone=function(t){return t&&"object"==typeof t?t.id:t},e.prototype.isChanged=function(t,e){return(t&&(null==t.id?t:t.id))!==(e&&(null==e.id?e:e.id))},e.prototype.validate=function(t,e,n){},e}(qt);Re.from=function(t){var i=kn(t);return new Yt({value:null,_attribute:Rn}).get(function(t,e){if("object"==typeof t)return t;var n=i(this),r=null;return n&&n.length&&(r=n.get(t)||null,(this.attributes[e]=r)&&this._attributes[e].handleChange(r,null,this,{})),r})},Sn.subsetOf=function(t){var e,n=this._SubsetOf||(this._SubsetOf=((e=function(o){function t(t,e){var n=o.call(this,[],e,In)||this;return n.resolvedWith=null,n.refs=Mn(t),n}return a(t,o),Object.defineProperty(t.prototype,"__inner_state__",{get:function(){return this.refs||this.models},enumerable:!0,configurable:!0}),t.prototype.add=function(t,e){void 0===e&&(e={});var n=this.resolvedWith,r=Mn(t);if(n)return o.prototype.add.call(this,Un(n,r),e);if(r.length){var i=Nt.begin(this);this.refs=this.refs?this.refs.concat(r):r.slice(),Nt.markAsDirty(this,e),i&&Nt.commit(this)}},t.prototype.reset=function(t,e){void 0===e&&(e={});var n=this.resolvedWith,r=Mn(t);return n?o.prototype.reset.call(this,Un(n,r),e):Hn(this,r,e)||[]},t.prototype._createTransaction=function(t,e){var n=this.resolvedWith,r=Mn(t);return n?o.prototype._createTransaction.call(this,Un(n,r),e):Hn(this,r,e)},t.prototype.toJSON=function(){return this.refs?this.refs.map(function(t){return t.id||t}):this.models.map(function(t){return t.id})},t.prototype._validateNested=function(){return 0},Object.defineProperty(t.prototype,"length",{get:function(){return this.models.length||(this.refs?this.refs.length:0)},enumerable:!0,configurable:!0}),t.prototype.clone=function(t){var e=this.constructor,n=new e([],{model:this.model,comparator:this.comparator});return this.resolvedWith?(n.resolvedWith=this.resolvedWith,n.refs=null,n.reset(this.models,{silent:!0})):n.refs=this.refs.slice(),n},t.prototype.parse=function(t){return t},t.prototype.resolve=function(t){return t&&t.length&&(this.resolvedWith=t,this.refs&&(this.reset(this.refs,{silent:!0}),this.refs=null)),this},t.prototype.getModelIds=function(){return this.toJSON()},t.prototype.toggle=function(t,e){return o.prototype.toggle.call(this,this.resolvedWith.get(t),e)},t.prototype.addAll=function(){if(this.resolvedWith)return this.set(this.resolvedWith.models),this.models;throw new Error("Cannot add elemens because the subset collection is not resolved yet.")},t.prototype.toggleAll=function(){return this.length?this.reset():this.addAll()},t=h([N],t)}(this)).prototype._itemEvents=void 0,e)),r=kn(t);return new Yt({type:n}).get(function(t){return!t||t.resolvedWith||t.resolve(r(this)),t})};var In=s.ItemsBehavior.share|s.ItemsBehavior.persistent;function Un(t,e){for(var n=[],r=0,i=e;r<i.length;r++){var o=i[r],s=t.get(o);s&&n.push(s)}return n}function Hn(t,e,n){if(x(t.refs,e)){var r=Nt.begin(t);t.refs=e.slice(),Nt.markAsDirty(t,n),r&&Nt.commit(t)}}function Mn(t){return t?Array.isArray(t)?t:[t]:[]}var Bn,$n=null,Jn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.getStore=function(){return this},e.prototype.get=function(t){var e=this[t];return e||this===this._defaultStore?e:this._owner?this._owner.get(t):this._defaultStore.get(t)},Object.defineProperty(e,"global",{get:function(){return $n},set:function(t){$n&&$n.dispose(),St.prototype._defaultStore=$n=t},enumerable:!0,configurable:!0}),e}(Re);Jn.global=new Jn,Object.setPrototypeOf||(Object.setPrototypeOf=l);var Vn=(Bn=ft).on,Fn=Bn.off,zn=Bn.trigger,qn=Bn.once,Ln=Bn.listenTo,Wn=Bn.stopListening,Kn=Bn.listenToOnce;function Gn(n){return function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.attributes=n,e=h([N],e)}(Re)}function Zn(t){return new Yt({value:t})}function Qn(i){return function(){for(var t,e=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return this.transaction(function(){t=i.apply(e,n)}),t}}var Xn=Object.freeze({on:Vn,off:Fn,trigger:zn,once:qn,listenTo:Ln,stopListening:Wn,listenToOnce:Kn,Model:Re,Class:P,attributes:Gn,value:Zn,transaction:Qn,tools:A,eventsApi:nt,Mixable:P,predefine:S,define:N,definitions:T,propertyListDecorator:D,definitionDecorator:k,MixinsState:R,mixins:U,mixinRules:H,EventMap:J,Messenger:pt,Events:ft,Collection:Sn,Store:Jn,Record:Re,attr:$e,prop:Je,createAttribute:Ce,createSharedTypeSpec:je,AnyType:qt,AggregatedType:Qt,DateType:ne,MSDateType:ie,TimestampType:oe,PrimitiveType:he,NumericType:le,ArrayType:fe,ObjectType:de,doNothing:ve,FunctionType:ye,SharedType:Oe,setAttribute:It,UpdateRecordMixin:Mt,constructorsMixin:Bt,shouldBeAnObject:$t,RecordTransaction:Jt,ChainableAttributeSpec:Yt,type:ee,get ItemsBehavior(){return s.ItemsBehavior},Transactional:St,transactionApi:Nt,getOwnerEndpoint:_t,createIOPromise:wt,startIO:Ot,abortIO:Et,triggerAndBubble:xt}),Yn=window.Backbone,tr={$:t,history:null,VERSION:"1.2.3",View:er,History:cr,Router:ir,noConflict:function(){return window.Backbone=Yn,this}};function er(t){this.cid=f.uniqueId("view"),t||(t={}),f.extend(this,f.pick(t,rr)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()}var nr=/^(\S+)\s*(.*)$/,rr=["model","collection","el","id","attributes","className","tagName","events"];function ir(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)}f.extend(er.prototype,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof tr.$?t:tr.$(t),this.el=this.$el[0],!1!==e&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=f.result(this,"events")))return this;for(var e in this.undelegateEvents(),t){var n=t[e];if(f.isFunction(n)||(n=this[t[e]]),n){var r=e.match(nr),i=r[1],o=r[2];n=f.bind(n,this),i+=".delegateEvents"+this.cid,""===o?this.$el.on(i,n):this.$el.on(i,o,n)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(f.result(this,"el"),!1);else{var t=f.extend({},f.result(this,"attributes"));this.id&&(t.id=f.result(this,"id")),this.className&&(t.class=f.result(this,"className"));var e=tr.$("<"+f.result(this,"tagName")+">").attr(t);this.setElement(e,!1)}}});var or=/\((.*?)\)/g,sr=/(\(\?)?:\w+/g,ar=/\*\w+/g,ur=/[\-{}\[\]+?.,\\\^$|#\s]/g;function cr(){this.handlers=[],this.checkUrl=f.bind(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)}f.extend(ir.prototype,{initialize:function(){},route:function(n,r,i){f.isRegExp(n)||(n=this._routeToRegExp(n)),f.isFunction(r)&&(i=r,r=""),i||(i=this[r]);var o=this;return tr.history.route(n,function(t){var e=o._extractParameters(n,t);!1!==o.execute(i,e,r)&&(o.trigger.apply(o,["route:"+r].concat(e)),o.trigger("route",r,e),tr.history.trigger("route",o,r,e))}),this},execute:function(t,e,n){t&&t.apply(this,e)},navigate:function(t,e){return tr.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=f.result(this,"routes");for(var t,e=f.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(ur,"\\$&").replace(or,"(?:$1)?").replace(sr,function(t,e){return e?t:"([^/?]+)"}).replace(ar,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return f.map(n,function(t,e){return e===n.length-1?t||null:t?decodeURIComponent(t):null})}});var hr=/^[#\/]|\s+$/g,lr=/^\/+|\/+$/g,pr=/#.*$/;cr.started=!1,f.extend(cr.prototype,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root&&!this.getSearch()},matchRoot:function(){return this.decodeFragment(this.location.pathname).slice(0,this.root.length-1)+"/"===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),t.replace(hr,"")},start:function(t){if(cr.started)throw new Error("Backbone.history has already been started");if(cr.started=!0,this.options=f.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._hasHashChange="onhashchange"in window&&(void 0===document.documentMode||7<document.documentMode),this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(lr,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var e=this.root.slice(0,-1)||"/";return this.location.replace(e+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var n=document.body,r=n.insertBefore(this.iframe,n.firstChild).contentWindow;r.document.open(),r.document.close(),r.location.hash="#"+this.fragment}var i=window.addEventListener||function(t,e){return attachEvent("on"+t,e)};if(this._usePushState?i("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?i("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var t=window.removeEventListener||function(t,e){return detachEvent("on"+t,e)};this._usePushState?t("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&t("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),cr.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe&&(e=this.getHash(this.iframe.contentWindow)),e===this.fragment)return!1;this.iframe&&this.navigate(e),this.loadUrl()},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),f.some(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0}))},navigate:function(t,e){if(!cr.started)return!1;e&&!0!==e||(e={trigger:!!e}),t=this.getFragment(t||"");var n=this.root;""!==t&&"?"!==t.charAt(0)||(n=n.slice(0,-1)||"/");var r=n+t;if(t=this.decodeFragment(t.replace(pr,"")),this.fragment!==t){if(this.fragment=t,this._usePushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantsHashChange)return this.location.assign(r);if(this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getHash(this.iframe.contentWindow)){var i=this.iframe.contentWindow;e.replace||(i.document.open(),i.document.close()),this._updateHash(i.location,t,e.replace)}}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,n){if(n){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else t.hash="#"+e}}),tr.history=new cr;var fr={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"},dr={$:tr.$,errorPromise:function(t){var e=$.Deferred();return e.reject(t),e},ajax:function(t){return $.ajax.apply($,arguments)},sync:function(t,e,r){void 0===r&&(r={});var n={type:fr[t],dataType:"json"};r.url||(n.url=f.result(e,"url")||dr.urlError());null!=r.data||!e||"create"!==t&&"update"!==t&&"patch"!==t||(n.contentType="application/json",n.data=JSON.stringify(r.attrs||e.toJSON(r)));"GET"!==n.type&&(n.processData=!1);var i=r.error;r.error=function(t,e,n){r.textStatus=e,r.errorThrown=n,i&&i.call(r.context,t,e,n)};var o=r.xhr=dr.ajax(f.extend(n,r));return e.trigger("request",e,o,r),e.collection&&e.collection.trigger("request",e,o,r),o},urlError:function(){throw new Error('A "url" property or function must be specified')}};var vr=l,yr=v(Re).prototype,gr=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.dispose=function(){this._xhr&&this._xhr.abort&&this._xhr.abort(),t.prototype.dispose.call(this)},e.prototype.url=function(){return this.model.prototype.urlRoot||""},e.prototype._invalidate=function(t){var e;if(t.validate&&(e=this.validationError))return this.trigger("invalid",this,e,f.extend({validationError:e},t)),!0},e.prototype.fetch=function(n){var r=(n=f.extend({parse:!0},n)).success,i=this;return n.success=function(t){var e=n.reset?"reset":"set";if(i[e](t,n),i._invalidate(n))return!1;r&&r.call(n.context,i,t,n),i.trigger("sync",i,t,n)},_r(this,n),br("read",this,n)},e.prototype.create=function(t,r){var i=this;void 0===r&&(r={});var e=t instanceof mr?t:this.model.create(t,r);e._owner||(e._owner=this),r.wait||this.add([e],r);var o=r.success;return r.success=function(t,e,n){r.wait&&i.add([t],vr({parse:!1},n)),o&&o.call(n.context,t,e,n)},e.save(null,r),e},e.prototype.sync=function(){return dr.sync.apply(this,arguments)},e=h([N({itemEvents:{destroy:function(t){this.remove(t)}}})],e)}(Sn),mr=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return a(t,i),t.prototype._invalidate=function(t){var e;if(t.validate&&(e=this.validationError))return wr(this,"invalid",this,e,f.extend({validationError:e},t)),!0},t.prototype.dispose=function(){this._xhr&&this._xhr.abort&&this._xhr.abort(),i.prototype.dispose.call(this)},t.prototype.fetch=function(e){e=f.extend({parse:!0},e);var n=this,r=e.success;return e.success=function(t){if(n.set(t,e),n._invalidate(e))return!1;r&&r.call(e.context,n,t,e),wr(n,"sync",n,t,e)},_r(this,e),br("read",this,e)},t.prototype.sync=function(){return dr.sync.apply(this,arguments)},t.prototype.save=function(t,e,n){var r,i,o=this;null==t||"object"==typeof t?(r=t,i=e||{}):((r={})[t]=e,i=n||{});var s=f.extend({validate:!0,parse:!0},i),a=s.wait;if(r&&!a&&this.set(r,i),this._invalidate(s))return r&&a&&this.set(r,i),dr.errorPromise(this.validationError);var u=this,c=s.success,h=this.attributes;s.success=function(t){if(u.attributes=h,a&&(t=f.extend({},r,t)),t&&(yr.set.call(o,t,s),u._invalidate(s)))return!1;c&&c.call(s.context,u,t,s),wr(u,"sync",u,t,s)},_r(this,s),r&&a&&(this.attributes=f.extend({},h,r));var l=this.isNew()?"create":s.patch?"patch":"update";"patch"!==l||s.attrs||(s.attrs=r);var p=br(l,this,s);return this.attributes=h,p},t.prototype.destroy=function(e){e=e?f.clone(e):{};var t,n=this,r=e.success,i=e.wait,o=function(){n.stopListening(),n.trigger("destroy",n,n.collection,e)};return e.success=function(t){i&&o(),r&&r.call(e.context,n,t,e),n.isNew()||wr(n,"sync",n,t,e)},this.isNew()?f.defer(e.success):(_r(this,e),t=br("delete",this,e)),i||o(),t||!1},t.prototype.url=function(){var t=f.result(this,"urlRoot")||f.result(this.collection,"url")||dr.urlError();if(this.isNew())return t;var e=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(e)},t.prototype.set=function(t,e,n){var r;return"string"==typeof t?n?i.prototype.set.call(this,((r={})[t]=e,r),n):(this[t]=e,this):i.prototype.set.call(this,t,e)},t.Collection=gr,t=h([N({urlRoot:""}),T({urlRoot:H.protoValue})],t)}(Re);function br(t,e,n){e._xhr&&e._xhr.abort&&e._xhr.abort();var r=e._xhr=e.sync(t,e,n);return r&&r.always&&r.always(function(){e._xhr=void 0}),r}function _r(e,n){var r=n.error;n.error=function(t){r&&r.call(n.context,e,t,n),wr(e,"error",e,t,n)}}function wr(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t.trigger.apply(t,e);var r=t.collection;r&&r.trigger.apply(r,e)}var Or,Er,xr,Cr={pick:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return f.pick(this,t)},escape:function(t){return f.escape(this[t])},matches:function(t){return!!f.iteratee(t,this)(this)},omit:function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return this.mapObject(function(t,e){if(n.indexOf(e)<0)return t})},invert:function(){var n={};return this.each(function(t,e){return n[t]=e}),n},pairs:function(){return this.map(function(t,e){return[e,t]})},isEmpty:function(){return!this.values().length},chain:function(){return f.chain(this.mapObject(function(t){return t}))}},jr={where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)}};function Ar(e,t){switch(typeof e){case"function":return e;case"string":return function(t){return t.get(e)};case"object":if(!(e instanceof t.model))return f.matches(e)}return e}Or=jr,Er="models",xr={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,findIndex:3,findLastIndex:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3},f.each(xr,function(t,e){f[e]&&(Or[e]=function(t,o,s){switch(t){case 1:return function(){return f[o](this[s])};case 2:return function(t){return f[o](this[s],t)};case 3:return function(t,e){var n=this[s],r=Ar(t,this);return 1<arguments.length?f[o](n,r,e):f[o](n,r)};case 4:return function(t,e,n){var r=this[s],i=Ar(t,this);return 1<arguments.length?f[o](r,i,e,n):f[o](r,i)};default:return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.unshift(this[s]),f[o].apply(f,t)}}}(t,e,Er))});var Pr=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e=h([N({getStore:Jn.prototype.getStore,get:Jn.prototype.get})],e)}(mr),Sr=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._resolved={},t}return a(t,e),t.prototype.initialize=function(){var i=this;this.each(function(t,e){if(t){t.store=i;var n=t.fetch;if(n){var r=i;t.fetch=function(){return r._resolved[e]=n.apply(this,arguments)}}t instanceof gr&&t.length&&(i._resolved[e]=!0)}})},t.prototype.fetch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=[],r=0,i=t.length?t:this.keys();r<i.length;r++){var o=i[r],s=this.attributes[o];s&&s.fetch&&n.push(s.fetch())}var a=tr.$;return a&&a.when&&a.when.apply(a,n)},t.prototype.fetchOnce=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=[],r=0,i=t.length?t:this.keys();r<i.length;r++){var o=i[r],s=this.attributes[o];n.push(this._resolved[o]||s&&s.fetch&&s.fetch())}var a=tr.$;return a&&a.when&&a.when.apply(a,n)},t.prototype.clear=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0,r=t.length?t:this.keys();n<r.length;n++){var i=r[n],o=this.attributes[i];o instanceof gr?o.reset():o instanceof Jn?o.clear():o instanceof mr&&o.set(o.defaults()),this._resolved[i]=!1}return this},t.onDefine=function(t,e){var n=t.defaults||t.attributes;f.each(n,function(t,e){t.has&&(n[e]=t.has.set(function(t){t&&t.length||((this._resolved||(this._resolved={}))[e]=!1);return t}))}),mr.onDefine.call(this,t,e)},t=h([N],t)}(Pr),Nr=pt,Tr=Object.create(Xn,l({sync:kr(dr,"sync"),errorPromise:kr(dr,"errorPromise"),ajax:kr(dr,"ajax"),history:kr(tr,"history"),store:kr(Jn,"global"),$:{get:function(){return tr.$},set:function(t){tr.$=dr.$=t}}},Rr({Backbone:tr,Class:Nr,Model:mr,Collection:gr,LazyStore:Sr,Store:Pr,defaults:Dr}),Rr(tr)));function Dr(t){return Tr.Model.defaults(t)}function kr(e,n){return{get:function(){return e[n]},set:function(t){e[n]=t}}}function Rr(t){return m({},t,function(t){return{value:t}})}R.get(Tr.Mixable).merge([Tr.Events]),Tr.Messenger.mixins.populate(tr.View,tr.Router,tr.History),Tr.Record.mixins.merge([Cr]),Tr.Record.Collection.mixins.merge([jr]),s.Class=Nr,s.default=Tr,s.Backbone=tr,s.RestStore=Pr,s.LazyStore=Sr,s.Collection=gr,s.Model=mr,s.defaults=Dr,s.on=Vn,s.off=Fn,s.trigger=zn,s.once=qn,s.listenTo=Ln,s.stopListening=Wn,s.listenToOnce=Kn,s.attributes=Gn,s.value=Zn,s.transaction=Qn,s.tools=A,s.eventsApi=nt,s.Mixable=P,s.predefine=S,s.define=N,s.definitions=T,s.propertyListDecorator=D,s.definitionDecorator=k,s.MixinsState=R,s.mixins=U,s.mixinRules=H,s.EventMap=J,s.Messenger=pt,s.Events=ft,s.Store=Jn,s.Record=Re,s.attr=$e,s.prop=Je,s.createAttribute=Ce,s.createSharedTypeSpec=je,s.AnyType=qt,s.AggregatedType=Qt,s.DateType=ne,s.MSDateType=ie,s.TimestampType=oe,s.PrimitiveType=he,s.NumericType=le,s.ArrayType=fe,s.ObjectType=de,s.doNothing=ve,s.FunctionType=ye,s.SharedType=Oe,s.setAttribute=It,s.UpdateRecordMixin=Mt,s.constructorsMixin=Bt,s.shouldBeAnObject=$t,s.RecordTransaction=Jt,s.ChainableAttributeSpec=Yt,s.type=ee,s.Transactional=St,s.transactionApi=Nt,s.getOwnerEndpoint=_t,s.createIOPromise=wt,s.startIO=Ot,s.abortIO=Et,s.triggerAndBubble=xt,s.View=er,s.Router=ir,s.History=cr,Object.defineProperty(s,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map

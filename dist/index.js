!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("type-r"),require("jquery"),require("underscore")):"function"==typeof define&&define.amd?define(["exports","type-r","jquery","underscore"],e):e(t.Nested={},t.Nested,t.$,t._)}(this,function(e,o,t,p){"use strict";var r=window.Backbone,h={$:t,history:null,VERSION:"1.2.3",View:n,History:d,Router:s,noConflict:function(){return window.Backbone=r,this}};function n(t){this.cid=p.uniqueId("view"),t||(t={}),p.extend(this,p.pick(t,i)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()}var a=/^(\S+)\s*(.*)$/,i=["model","collection","el","id","attributes","className","tagName","events"];function s(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)}p.extend(n.prototype,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof h.$?t:h.$(t),this.el=this.$el[0],!1!==e&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=p.result(this,"events")))return this;for(var e in this.undelegateEvents(),t){var r=t[e];if(p.isFunction(r)||(r=this[t[e]]),r){var n=e.match(a),i=n[1],s=n[2];r=p.bind(r,this),i+=".delegateEvents"+this.cid,""===s?this.$el.on(i,r):this.$el.on(i,s,r)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(p.result(this,"el"),!1);else{var t=p.extend({},p.result(this,"attributes"));this.id&&(t.id=p.result(this,"id")),this.className&&(t.class=p.result(this,"className"));var e=h.$("<"+p.result(this,"tagName")+">").attr(t);this.setElement(e,!1)}}});var u=/\((.*?)\)/g,c=/(\(\?)?:\w+/g,l=/\*\w+/g,f=/[\-{}\[\]+?.,\\\^$|#\s]/g;function d(){this.handlers=[],this.checkUrl=p.bind(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)}p.extend(s.prototype,{initialize:function(){},route:function(r,n,i){p.isRegExp(r)||(r=this._routeToRegExp(r)),p.isFunction(n)&&(i=n,n=""),i||(i=this[n]);var s=this;return h.history.route(r,function(t){var e=s._extractParameters(r,t);!1!==s.execute(i,e,n)&&(s.trigger.apply(s,["route:"+n].concat(e)),s.trigger("route",n,e),h.history.trigger("route",s,n,e))}),this},execute:function(t,e,r){t&&t.apply(this,e)},navigate:function(t,e){return h.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=p.result(this,"routes");for(var t,e=p.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(f,"\\$&").replace(u,"(?:$1)?").replace(c,function(t,e){return e?t:"([^/?]+)"}).replace(l,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var r=t.exec(e).slice(1);return p.map(r,function(t,e){return e===r.length-1?t||null:t?decodeURIComponent(t):null})}});var v=/^[#\/]|\s+$/g,g=/^\/+|\/+$/g,y=/#.*$/;d.started=!1,p.extend(d.prototype,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root&&!this.getSearch()},matchRoot:function(){return this.decodeFragment(this.location.pathname).slice(0,this.root.length-1)+"/"===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),t.replace(v,"")},start:function(t){if(d.started)throw new Error("Backbone.history has already been started");if(d.started=!0,this.options=p.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._hasHashChange="onhashchange"in window&&(void 0===document.documentMode||7<document.documentMode),this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(g,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var e=this.root.slice(0,-1)||"/";return this.location.replace(e+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var r=document.body,n=r.insertBefore(this.iframe,r.firstChild).contentWindow;n.document.open(),n.document.close(),n.location.hash="#"+this.fragment}var i=window.addEventListener||function(t,e){return attachEvent("on"+t,e)};if(this._usePushState?i("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?i("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var t=window.removeEventListener||function(t,e){return detachEvent("on"+t,e)};this._usePushState?t("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&t("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),d.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe&&(e=this.getHash(this.iframe.contentWindow)),e===this.fragment)return!1;this.iframe&&this.navigate(e),this.loadUrl()},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),p.some(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0}))},navigate:function(t,e){if(!d.started)return!1;e&&!0!==e||(e={trigger:!!e}),t=this.getFragment(t||"");var r=this.root;""!==t&&"?"!==t.charAt(0)||(r=r.slice(0,-1)||"/");var n=r+t;if(t=this.decodeFragment(t.replace(y,"")),this.fragment!==t){if(this.fragment=t,this._usePushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);if(this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getHash(this.iframe.contentWindow)){var i=this.iframe.contentWindow;e.replace||(i.document.open(),i.document.close()),this._updateHash(i.location,t,e.replace)}}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,r){if(r){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),h.history=new d;var m=function(t,e){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function _(t,e){function r(){this.constructor=t}m(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function w(t,e,r,n){var i,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(o=(s<3?i(o):3<s?i(e,r,o):i(e,r))||o);return 3<s&&o&&Object.defineProperty(e,r,o),o}var x={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"},b={$:h.$,errorPromise:function(t){var e=$.Deferred();return e.reject(t),e},ajax:function(t){return $.ajax.apply($,arguments)},sync:function(t,e,n){void 0===n&&(n={});var r={type:x[t],dataType:"json"};n.url||(r.url=p.result(e,"url")||b.urlError());null!=n.data||!e||"create"!==t&&"update"!==t&&"patch"!==t||(r.contentType="application/json",r.data=JSON.stringify(n.attrs||e.toJSON(n)));"GET"!==r.type&&(r.processData=!1);var i=n.error;n.error=function(t,e,r){n.textStatus=e,n.errorThrown=r,i&&i.call(n.context,t,e,r)};var s=n.xhr=b.ajax(p.extend(r,n));return e.trigger("request",e,s,n),e.collection&&e.collection.trigger("request",e,s,n),s},urlError:function(){throw new Error('A "url" property or function must be specified')}};var S=o.tools.defaults,E=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return _(e,t),e.prototype.dispose=function(){this._xhr&&this._xhr.abort&&this._xhr.abort(),t.prototype.dispose.call(this)},e.prototype.url=function(){return this.model.prototype.urlRoot||""},e.prototype._invalidate=function(t){var e;if(t.validate&&(e=this.validationError))return this.trigger("invalid",this,e,p.extend({validationError:e},t)),!0},e.prototype.fetch=function(r){var n=(r=p.extend({parse:!0},r)).success,i=this;return r.success=function(t){var e=r.reset?"reset":"set";if(i[e](t,r),i._invalidate(r))return!1;n&&n.call(r.context,i,t,r),i.trigger("sync",i,t,r)},j(this,r),k("read",this,r)},e.prototype.create=function(t,n){var i=this;void 0===n&&(n={});var e=t instanceof R?t:this.model.create(t,n);e._owner||(e._owner=this),n.wait||this.add([e],n);var s=n.success;return n.success=function(t,e,r){n.wait&&i.add([t],S({parse:!1},r)),s&&s.call(r.context,t,e,r)},e.save(null,n),e},e.prototype.sync=function(){return b.sync.apply(this,arguments)},e=w([o.define({itemEvents:{destroy:function(t){this.remove(t)}}})],e)}(o.Collection),P=o.Model.prototype,R=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return _(t,i),t.prototype._invalidate=function(t){var e;if(t.validate&&(e=this.validationError))return C(this,"invalid",this,e,p.extend({validationError:e},t)),!0},t.prototype.dispose=function(){this._xhr&&this._xhr.abort&&this._xhr.abort(),i.prototype.dispose.call(this)},t.prototype.fetch=function(e){e=p.extend({parse:!0},e);var r=this,n=e.success;return e.success=function(t){if(r.set(t,e),r._invalidate(e))return!1;n&&n.call(e.context,r,t,e),C(r,"sync",r,t,e)},j(this,e),k("read",this,e)},t.prototype.sync=function(){return b.sync.apply(this,arguments)},t.prototype.save=function(t,e,r){var n,i,s=this;i=null==t||"object"==typeof t?(n=t,e||{}):((n={})[t]=e,r||{});var o=p.extend({validate:!0,parse:!0},i),a=o.wait;if(n&&!a&&this.set(n,i),this._invalidate(o))return n&&a&&this.set(n,i),b.errorPromise(this.validationError);var h=this,u=o.success,c=this.attributes;o.success=function(t){if(h.attributes=c,a&&(t=p.extend({},n,t)),t&&(P.set.call(s,t,o),h._invalidate(o)))return!1;u&&u.call(o.context,h,t,o),C(h,"sync",h,t,o)},j(this,o),n&&a&&(this.attributes=p.extend({},c,n));var l=this.isNew()?"create":o.patch?"patch":"update";"patch"!==l||o.attrs||(o.attrs=n);var f=k(l,this,o);return this.attributes=c,f},t.prototype.destroy=function(e){e=e?p.clone(e):{};var t,r=this,n=e.success,i=e.wait,s=function(){r.stopListening(),r.trigger("destroy",r,r.collection,e)};return e.success=function(t){i&&s(),n&&n.call(e.context,r,t,e),r.isNew()||C(r,"sync",r,t,e)},this.isNew()?p.defer(e.success):(j(this,e),t=k("delete",this,e)),i||s(),t||!1},t.prototype.url=function(){var t=p.result(this,"urlRoot")||p.result(this.collection,"url")||b.urlError();if(this.isNew())return t;var e=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(e)},t.prototype.set=function(t,e,r){var n;return"string"==typeof t?r?i.prototype.set.call(this,((n={})[t]=e,n),r):(this[t]=e,this):i.prototype.set.call(this,t,e)},t.Collection=E,t=w([o.define({urlRoot:""}),o.definitions({urlRoot:o.mixinRules.protoValue})],t)}(o.Model);function k(t,e,r){e._xhr&&e._xhr.abort&&e._xhr.abort();var n=e._xhr=e.sync(t,e,r);return n&&n.always&&n.always(function(){e._xhr=void 0}),n}function j(e,r){var n=r.error;r.error=function(t){n&&n.call(r.context,e,t,r),C(e,"error",e,t,r)}}function C(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];t.trigger.apply(t,e);var n=t.collection;n&&n.trigger.apply(n,e)}var H=/\/Date\(([0-9]+)\)\//,O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return _(e,t),e.prototype.convert=function(t){if("string"==typeof t){var e=H.exec(t);if(e)return new Date(Number(e[1]))}return o.DateType.prototype.convert.apply(this,arguments)},e.prototype.toJSON=function(t){return t&&"/Date("+t.getTime()+")/"},e}(o.DateType),N=new o.ChainableAttributeSpec({type:Date,_metatype:O}),z=o.type(Date).toJSON(function(t){return t&&t.getTime()});function U(t){return t?Math.round(t):0}U._metatype=o.NumericType;var I=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,}))\.?)(?::\d{2,5})?(?:[/?#]\S*)?$/i;function T(t){return!t||I.test(t)}T.error="Not valid URL";o.type(String).check(T);var D=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;function F(t){return!t||D.test(t)}F.error="Not valid IP address";o.type(String).check(F);var M=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;function q(t){return!t||!!t.match(M)}q.error="Not valid email";o.type(String).check(q);Function.prototype.value=function(t){return new o.ChainableAttributeSpec({type:this,value:t,hasCustomDefault:!0})},Object.defineProperty(Function.prototype,"isRequired",{get:function(){return this._isRequired||this.has.isRequired},set:function(t){this._isRequired=t}}),Object.defineProperty(Function.prototype,"asProp",{get:function(){return this.has.asProp}}),Object.defineProperty(Function.prototype,"has",{get:function(){return this._has||o.type(this)},set:function(t){this._has=t}}),Object.defineProperties(Date,{microsoft:{value:N},timestamp:{value:z}}),Number.integer=U,"undefined"!=typeof window&&(window.Integer=U);var B,A,L,V=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return _(e,t),e=w([o.define({getStore:o.Store.prototype.getStore,get:o.Store.prototype.get})],e)}(R),W=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._resolved={},t}return _(t,e),t.prototype.initialize=function(){var i=this;this.forEach(function(t,e){if(t){t.store=i;var r=t.fetch;if(r){var n=i;t.fetch=function(){return n._resolved[e]=r.apply(this,arguments)}}t instanceof E&&t.length&&(i._resolved[e]=!0)}})},t.prototype.fetch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r=[],n=0,i=t.length?t:this.keys();n<i.length;n++){var s=i[n],o=this.attributes[s];o&&o.fetch&&r.push(o.fetch())}var a=h.$;return a&&a.when&&a.when.apply(a,r)},t.prototype.fetchOnce=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r=[],n=0,i=t.length?t:this.keys();n<i.length;n++){var s=i[n],o=this.attributes[s];r.push(this._resolved[s]||o&&o.fetch&&o.fetch())}var a=h.$;return a&&a.when&&a.when.apply(a,r)},t.prototype.clear=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r=0,n=t.length?t:this.keys();r<n.length;r++){var i=n[r],s=this.attributes[i];s instanceof E?s.reset():s instanceof o.Store?s.clear():s instanceof R&&s.set(s.defaults()),this._resolved[i]=!1}return this},t.onDefine=function(t,e){var r=t.defaults||t.attributes;p.each(r,function(t,e){t.has&&(r[e]=t.has.set(function(t){t&&t.length||((this._resolved||(this._resolved={}))[e]=!1);return t}))}),R.onDefine.call(this,t,e)},t=w([o.define],t)}(V),J={pick:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return p.pick(this,t)},values:function(){var e=this;return this.keys().map(function(t){return e[t]})},each:o.Model.prototype.forEach,escape:function(t){return p.escape(this[t])},matches:function(t){return!!p.iteratee(t,this)(this)},omit:function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return this.mapObject(function(t,e){if(r.indexOf(e)<0)return t})},invert:function(){var r={};return this.each(function(t,e){return r[t]=e}),r},pairs:function(){return this.map(function(t,e){return[e,t]})},isEmpty:function(){return!this.values().length},chain:function(){return p.chain(this.mapObject(function(t){return t}))}},G={where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)}};function K(e,t){switch(typeof e){case"function":return e;case"string":return function(t){return t.get(e)};case"object":if(!(e instanceof t.model))return p.matches(e)}return e}B=G,A="models",L={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,findIndex:3,findLastIndex:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3},p.each(L,function(t,e){p[e]&&(B[e]=function(t,s,o){switch(t){case 1:return function(){return p[s](this[o])};case 2:return function(t){return p[s](this[o],t)};case 3:return function(t,e){var r=this[o],n=K(t,this);return 1<arguments.length?p[s](r,n,e):p[s](r,n)};case 4:return function(t,e,r){var n=this[o],i=K(t,this);return 1<arguments.length?p[s](n,i,e,r):p[s](n,i)};default:return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.unshift(this[o]),p[s].apply(p,t)}}}(t,e,A))});var Q=o.Messenger,X=Object.create(o,o.tools.defaults({sync:Z(b,"sync"),errorPromise:Z(b,"errorPromise"),ajax:Z(b,"ajax"),history:Z(h,"history"),store:Z(o.Store,"global"),$:{get:function(){return h.$},set:function(t){h.$=b.$=t}}},tt({Backbone:h,Class:Q,Model:R,Collection:E,LazyStore:W,Store:V,defaults:Y}),tt(h)));function Y(t){return X.Model.defaults(t)}function Z(e,r){return{get:function(){return e[r]},set:function(t){e[r]=t}}}function tt(t){return o.tools.transform({},t,function(t){return{value:t}})}o.MixinsState.get(X.Mixable).merge([X.Events]),X.Messenger.mixins.populate(h.View,h.Router,h.History),X.Record.mixins.merge([J]),X.Record.Collection.mixins.merge([G]),e.Backbone=h,e.RestStore=V,e.LazyStore=W,e.Collection=E,e.Model=R,e.Class=Q,e.default=X,e.defaults=Y,Object.keys(o).forEach(function(t){e[t]=o[t]}),e.View=o.View,e.Router=o.Router,e.History=o.History,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
